# Project Forest - インフラストラクチャ設計書

## 概要

本ドキュメントは、Project Forest（テキスト管理システム）のAWSインフラストラクチャの詳細設計と構成を説明します。高可用性、スケーラビリティ、セキュリティを考慮した本番環境向けの設計となっています。

## アーキテクチャ概要

```
Internet
    ↓
[Route53] → [CloudFront] → [ALB] → [EC2 Auto Scaling Group]
                              ↓
                          [Private Subnet]
                              ↓
                          [RDS Multi-AZ]
                              ↓
                          [ElastiCache]
```

## ネットワーク設計

### VPC構成

| 項目 | 設定値 | 説明 |
|------|--------|------|
| VPC CIDR | 10.0.0.0/16 | 65,536個のIPアドレスを提供 |
| アベイラビリティゾーン | ap-northeast-1a, 1c | 冗長性確保のため2つのAZを使用 |
| DNS解決 | 有効 | Route53との連携のため |
| DNSホスト名 | 有効 | インスタンスの名前解決のため |

### サブネット設計

#### パブリックサブネット
| サブネット | CIDR | AZ | 用途 |
|------------|------|----|----- |
| PublicSubnet1A | 10.0.1.0/24 | ap-northeast-1a | ALB、NAT Gateway |
| PublicSubnet1C | 10.0.2.0/24 | ap-northeast-1c | ALB、NAT Gateway |

#### プライベートサブネット
| サブネット | CIDR | AZ | 用途 |
|------------|------|----|----- |
| PrivateSubnet1A | 10.0.11.0/24 | ap-northeast-1a | Web/App サーバー |
| PrivateSubnet1C | 10.0.12.0/24 | ap-northeast-1c | Web/App サーバー |
| DBSubnet1A | 10.0.21.0/24 | ap-northeast-1a | RDS |
| DBSubnet1C | 10.0.22.0/24 | ap-northeast-1c | RDS |
| CacheSubnet1A | 10.0.31.0/24 | ap-northeast-1a | ElastiCache |
| CacheSubnet1C | 10.0.32.0/24 | ap-northeast-1c | ElastiCache |

### ルーティング設計

#### パブリックルートテーブル
| 宛先 | ターゲット | 説明 |
|------|------------|------|
| 10.0.0.0/16 | Local | VPC内通信 |
| 0.0.0.0/0 | Internet Gateway | インターネット向け通信 |

#### プライベートルートテーブル
| 宛先 | ターゲット | 説明 |
|------|------------|------|
| 10.0.0.0/16 | Local | VPC内通信 |
| 0.0.0.0/0 | NAT Gateway | アウトバウンド通信 |

## セキュリティ設計

### セキュリティグループ

#### ALBセキュリティグループ (ALB-SG)
| ルール | プロトコル | ポート | ソース | 説明 |
|--------|------------|--------|--------|------|
| インバウンド | HTTP | 80 | 0.0.0.0/0 | HTTP リダイレクト |
| インバウンド | HTTPS | 443 | 0.0.0.0/0 | HTTPS トラフィック |
| アウトバウンド | All | All | 0.0.0.0/0 | 全てのアウトバウンド |

#### Webサーバーセキュリティグループ (Web-SG)
| ルール | プロトコル | ポート | ソース | 説明 |
|--------|------------|--------|--------|------|
| インバウンド | HTTP | 3000 | ALB-SG | ALBからのアプリケーション通信 |
| インバウンド | SSH | 22 | Bastion-SG | 踏み台サーバーからの管理アクセス |
| アウトバウンド | All | All | 0.0.0.0/0 | 全てのアウトバウンド |

#### データベースセキュリティグループ (DB-SG)
| ルール | プロトコル | ポート | ソース | 説明 |
|--------|------------|--------|--------|------|
| インバウンド | MySQL | 3306 | Web-SG | Webサーバーからのデータベースアクセス |
| インバウンド | MySQL | 3306 | Bastion-SG | 管理用アクセス |

#### ElastiCacheセキュリティグループ (Cache-SG)
| ルール | プロトコル | ポート | ソース | 説明 |
|--------|------------|--------|--------|------|
| インバウンド | Redis | 6379 | Web-SG | Webサーバーからのキャッシュアクセス |

#### Bastionセキュリティグループ (Bastion-SG)
| ルール | プロトコル | ポート | ソース | 説明 |
|--------|------------|--------|--------|------|
| インバウンド | SSH | 22 | 管理者IP | 管理者からのSSHアクセス |
| アウトバウンド | All | All | 0.0.0.0/0 | 全てのアウトバウンド |

### NACLs（Network Access Control Lists）

#### パブリックサブネット用NACL
| ルール番号 | タイプ | プロトコル | ポート範囲 | ソース | 許可/拒否 |
|------------|--------|------------|------------|--------|-----------|
| 100 | HTTP | TCP | 80 | 0.0.0.0/0 | ALLOW |
| 110 | HTTPS | TCP | 443 | 0.0.0.0/0 | ALLOW |
| 120 | SSH | TCP | 22 | 管理者CIDR | ALLOW |
| 130 | Ephemeral | TCP | 1024-65535 | 0.0.0.0/0 | ALLOW |
| * | All | All | All | 0.0.0.0/0 | DENY |

#### プライベートサブネット用NACL
| ルール番号 | タイプ | プロトコル | ポート範囲 | ソース | 許可/拒否 |
|------------|--------|------------|------------|--------|-----------|
| 100 | HTTP | TCP | 3000 | 10.0.1.0/24 | ALLOW |
| 110 | HTTP | TCP | 3000 | 10.0.2.0/24 | ALLOW |
| 120 | SSH | TCP | 22 | 10.0.1.0/24 | ALLOW |
| 130 | SSH | TCP | 22 | 10.0.2.0/24 | ALLOW |
| 140 | HTTPS | TCP | 443 | 0.0.0.0/0 | ALLOW |
| 150 | DNS | UDP | 53 | 0.0.0.0/0 | ALLOW |
| 160 | Ephemeral | TCP | 1024-65535 | 0.0.0.0/0 | ALLOW |
| * | All | All | All | 0.0.0.0/0 | DENY |

## コンピュート設計

### EC2インスタンス設計

#### 本番環境設定
| 項目 | 設定値 | 説明 |
|------|--------|------|
| インスタンスタイプ | t3.large | 2vCPU、8GB RAM |
| AMI | Amazon Linux 2 | 最新版（セキュリティアップデート済み） |
| ストレージ | gp3 30GB | 高性能SSD、暗号化有効 |
| キーペア | ProjectForestKey | SSH接続用 |
| 配置 | マルチAZ | 高可用性のため |

#### 開発・ステージング環境設定
| 項目 | 設定値 | 説明 |
|------|--------|------|
| インスタンスタイプ | t3.medium | 2vCPU、4GB RAM |
| AMI | Amazon Linux 2 | 本番環境と同じ |
| ストレージ | gp3 20GB | コスト最適化 |

### Auto Scaling設計

#### Auto Scaling Group設定
| 項目 | 設定値 | 説明 |
|------|--------|------|
| 最小キャパシティ | 2 | 最低2台で可用性確保 |
| 希望キャパシティ | 2 | 通常時の稼働台数 |
| 最大キャパシティ | 6 | 負荷増加時の最大スケール |
| ヘルスチェック猶予期間 | 300秒 | インスタンス起動時間を考慮 |
| ヘルスチェックタイプ | ELB | ALBによるアプリケーションレベルチェック |

#### スケーリングポリシー
| ポリシー名 | タイプ | メトリクス | 閾値 | アクション |
|------------|--------|------------|------|----------|
| Scale-Up | ステップスケーリング | CPU使用率 | 70% | インスタンス追加 |
| Scale-Down | ステップスケーリング | CPU使用率 | 30% | インスタンス削除 |
| Target-Tracking | ターゲット追跡 | CPU使用率 | 50% | 自動調整 |

### Application Load Balancer設計

#### ALB設定
| 項目 | 設定値 | 説明 |
|------|--------|------|
| スキーム | Internet-facing | インターネット向け |
| IP アドレス タイプ | IPv4 | IPv4のみサポート |
| サブネット | PublicSubnet1A, 1C | マルチAZ配置 |
| 削除保護 | 有効 | 誤削除防止 |

#### ターゲットグループ設定
| 項目 | 設定値 | 説明 |
|------|--------|------|
| プロトコル | HTTP | ポート3000 |
| ヘルスチェックパス | /api/health | アプリケーションのヘルスチェック |
| ヘルスチェック間隔 | 30秒 | 定期的な健全性確認 |
| ヘルスチェックタイムアウト | 5秒 | レスポンス待機時間 |
| 健全性の閾値 | 2回連続成功 | 正常判定の条件 |
| 非健全性の閾値 | 2回連続失敗 | 異常判定の条件 |

## データベース設計

### RDS設定

#### 本番環境設定
| 項目 | 設定値 | 説明 |
|------|--------|------|
| エンジン | MySQL 8.0.35 | 最新の安定版 |
| インスタンスクラス | db.t3.small | 2vCPU、2GB RAM |
| ストレージ | gp3 100GB | 高性能SSD |
| マルチAZ | 有効 | 高可用性とフェイルオーバー |
| 自動バックアップ | 30日保持 | ポイントインタイムリカバリ |
| バックアップウィンドウ | 03:00-04:00 JST | 負荷の少ない時間帯 |
| メンテナンスウィンドウ | 日曜 04:00-05:00 JST | 影響の少ない時間帯 |
| 削除保護 | 有効 | 誤削除防止 |
| 暗号化 | 有効 | データ保護 |

#### リードレプリカ設定（オプション）
| 項目 | 設定値 | 説明 |
|------|--------|------|
| リードレプリカ数 | 1台 | 読み取り負荷分散 |
| 配置 | 異なるAZ | 障害隔離 |
| インスタンスクラス | db.t3.small | マスターと同等 |
| 自動フェイルオーバー | 無効 | リードオンリー用途 |

### データベース監視設定

#### CloudWatchメトリクス
| メトリクス | 閾値 | アクション |
|------------|------|----------|
| CPU使用率 | 80% | アラート通知 |
| 接続数 | 80% of max | アラート通知 |
| フリーストレージ容量 | 10GB未満 | アラート通知 |
| レプリケーション遅延 | 60秒 | アラート通知 |

#### Performance Insights
| 項目 | 設定値 | 説明 |
|------|--------|------|
| Performance Insights | 有効 | データベースパフォーマンス監視 |
| 保持期間 | 7日間 | 無料枠での運用 |

## キャッシュ設計

### ElastiCache for Redis設定

#### クラスター設定
| 項目 | 設定値 | 説明 |
|------|--------|------|
| エンジン | Redis 7.0 | 最新の安定版 |
| ノードタイプ | cache.t3.micro | 開発・検証用 |
| レプリケーショングループ | 有効 | 高可用性確保 |
| シャード数 | 1 | 単一シャード構成 |
| レプリカ数 | 1 | マスター+レプリカ構成 |
| マルチAZ | 有効 | 自動フェイルオーバー |
| 暗号化（保存時） | 有効 | データ保護 |
| 暗号化（転送時） | 有効 | 通信保護 |
| バックアップ | 有効 | 自動バックアップ |

#### 本番環境での推奨設定
| 項目 | 設定値 | 説明 |
|------|--------|------|
| ノードタイプ | cache.t3.small | 1.5GB メモリ |
| シャード数 | 2 | 負荷分散 |
| レプリカ数 | 2 | 高可用性 |

## ストレージ設計

### S3設計

#### バケット構成
| バケット名 | 用途 | アクセス制御 | 暗号化 |
|------------|------|------------|-------|
| projectforest-static-{timestamp} | 静的ファイル | PublicRead | AES-256 |
| projectforest-uploads-{timestamp} | ファイルアップロード | Private | AES-256 |
| projectforest-backup-{timestamp} | バックアップ | Private | KMS |
| projectforest-logs-{timestamp} | ログアーカイブ | Private | AES-256 |

#### ライフサイクルポリシー
| バケット | ルール | 期間 | アクション |
|----------|--------|------|----------|
| static | 古いバージョン削除 | 30日 | 削除 |
| uploads | IA移行 | 30日 | Standard-IA |
| uploads | Glacier移行 | 90日 | Glacier |
| backup | Glacier移行 | 1日 | Glacier |
| logs | IA移行 | 30日 | Standard-IA |
| logs | Glacier移行 | 90日 | Glacier |

### EBSボリューム設計

#### 本番環境設定
| インスタンス | ボリュームタイプ | サイズ | IOPS | 暗号化 |
|-------------|------------------|------|------|-------|
| Web/App | gp3 | 30GB | 3000 | 有効 |
| Bastion | gp3 | 10GB | 3000 | 有効 |

#### スナップショット設定
| 項目 | 設定値 | 説明 |
|------|--------|------|
| 自動スナップショット | 有効 | 日次バックアップ |
| 保持期間 | 7日 | コスト最適化 |
| タグ付け | 有効 | 管理の簡素化 |

## Content Delivery Network（CDN）

### CloudFront設計

#### ディストリビューション設定
| 項目 | 設定値 | 説明 |
|------|--------|------|
| オリジン | ALB + S3 | 動的・静的コンテンツ |
| プライスクラス | All | 全世界での最適配信 |
| SSL証明書 | ACM証明書 | 独自ドメイン対応 |
| HTTP版リダイレクト | HTTPS | セキュリティ強化 |
| 圧縮 | 有効 | 転送量削減 |

#### キャッシュビヘイビア
| パス | オリジン | TTL | ヘッダー転送 |
|------|----------|-----|-------------|
| /api/* | ALB | 0 | Authorization, Cookie |
| /admin/* | ALB | 0 | 全て |
| /static/* | S3 | 1年 | なし |
| /* | ALB | 24時間 | Host |

## DNS設計

### Route53設定

#### ホストゾーン設定
| レコードタイプ | 名前 | 値 | TTL |
|----------------|------|----|----- |
| A | @ | CloudFront Distribution | 300 |
| A | www | CloudFront Distribution | 300 |
| CNAME | api | ALB DNS名 | 300 |
| MX | @ | メールサーバー | 300 |
| TXT | @ | SPF, DKIM設定 | 300 |

#### ヘルスチェック設定
| 項目 | 設定値 | 説明 |
|------|--------|------|
| プロトコル | HTTPS | セキュア接続 |
| パス | /api/health | アプリケーションチェック |
| 間隔 | 30秒 | 定期的な監視 |
| 失敗回数の閾値 | 3回 | フェイルオーバー判定 |

## 監視・ログ設計

### CloudWatch設定

#### メトリクスアラーム
| リソース | メトリクス | 閾値 | 評価期間 | アクション |
|----------|------------|------|----------|-----------|
| EC2 | CPU使用率 | 80% | 2分間 | SNS通知 |
| EC2 | メモリ使用率 | 85% | 2分間 | SNS通知 |
| ALB | 5XXエラー率 | 5% | 5分間 | SNS通知 |
| RDS | CPU使用率 | 80% | 5分間 | SNS通知 |
| RDS | 接続数 | 80% | 5分間 | SNS通知 |
| ElastiCache | CPU使用率 | 80% | 5分間 | SNS通知 |

#### ログ保持設定
| ロググループ | 保持期間 | 説明 |
|-------------|----------|------|
| /aws/ec2/project-forest/app | 14日 | アプリケーションログ |
| /aws/ec2/project-forest/nginx-access | 7日 | Nginxアクセスログ |
| /aws/ec2/project-forest/nginx-error | 30日 | Nginxエラーログ |
| /aws/elasticloadbalancing/app/alb | 7日 | ALBアクセスログ |

### AWS X-Ray設定

#### トレース設定
| 項目 | 設定値 | 説明 |
|------|--------|------|
| トレース有効化 | Next.js API Routes | API パフォーマンス監視 |
| サンプリング率 | 10% | コスト最適化 |
| 保持期間 | 30日 | 分析用データ保持 |

## セキュリティ設計

### IAMロール・ポリシー設計

#### EC2インスタンス用IAMロール
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject"
      ],
      "Resource": [
        "arn:aws:s3:::projectforest-uploads-*/*",
        "arn:aws:s3:::projectforest-static-*/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:ap-northeast-1:*:log-group:/aws/ec2/project-forest/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "xray:PutTraceSegments",
        "xray:PutTelemetryRecords"
      ],
      "Resource": "*"
    }
  ]
}
```

### AWS WAF設定

#### Webアプリケーション保護
| ルール | 説明 | アクション |
|--------|------|----------|
| AWSManagedRulesCommonRuleSet | 一般的な攻撃パターン | Block |
| AWSManagedRulesKnownBadInputsRuleSet | 悪意のある入力 | Block |
| AWSManagedRulesSQLiRuleSet | SQLインジェクション | Block |
| AWSManagedRulesUnixRuleSet | Unix系攻撃 | Block |
| Rate Limiting | リクエスト制限 | Block（1000req/5min） |
| IP Whitelist | 管理者IP許可 | Allow |

### AWS Shield設定

#### DDoS保護
| 項目 | 設定値 | 説明 |
|------|--------|------|
| AWS Shield Standard | 有効 | 基本的なDDoS保護 |
| AWS Shield Advanced | オプション | 高度なDDoS保護 |

## バックアップ・災害復旧設計

### バックアップ戦略

#### RDSバックアップ
- **自動バックアップ**: 30日保持
- **手動スナップショット**: 重要なマイルストーン時
- **リードレプリカ**: 本番データの複製

#### EBSスナップショット
- **日次自動スナップショット**: 7日保持
- **週次アーカイブ**: 4週保持

#### S3バックアップ
- **Cross-Region Replication**: 大阪リージョンへの複製
- **バージョニング**: 誤削除対策

### 災害復旧計画

#### RTO（Recovery Time Objective）
- **アプリケーションサーバー**: 30分
- **データベース**: 15分（Multi-AZ自動フェイルオーバー）
- **全体システム**: 1時間

#### RPO（Recovery Point Objective）
- **データベース**: 15分（Multi-AZ構成）
- **ファイル**: 24時間（日次バックアップ）

## コスト最適化

### 推定月額コスト（東京リージョン）

#### 本番環境
| サービス | 仕様 | 月額コスト（USD） |
|----------|------|------------------|
| EC2 | t3.large × 2台 | $120 |
| RDS | db.t3.small Multi-AZ | $60 |
| ElastiCache | cache.t3.micro | $15 |
| ALB | 標準設定 | $20 |
| S3 | 100GB + 転送量 | $10 |
| CloudFront | 標準使用量 | $5 |
| Route53 | 1ドメイン | $0.5 |
| CloudWatch | 標準監視 | $10 |
| **合計** | | **$240.5** |

#### 開発環境
| サービス | 仕様 | 月額コスト（USD） |
|----------|------|------------------|
| EC2 | t3.medium × 1台 | $30 |
| RDS | db.t3.micro | $15 |
| その他 | 最小構成 | $15 |
| **合計** | | **$60** |

### コスト削減施策

1. **Reserved Instance**: 1年予約で最大40%削減
2. **Spot Instance**: 開発環境で最大70%削減
3. **S3 Intelligent Tiering**: 自動的なストレージクラス最適化
4. **CloudWatch ログ保持期間最適化**: 不要なログの早期削除

## パフォーマンス設計

### 想定パフォーマンス

#### レスポンス時間目標
| エンドポイント | 目標時間 | 測定条件 |
|---------------|----------|----------|
| 静的ページ | < 200ms | CloudFront経由 |
| API（簡単な操作） | < 500ms | データベースアクセス無し |
| API（データベースアクセス） | < 1000ms | 通常のクエリ |
| ファイルアップロード | < 5000ms | 10MB以下 |

#### スループット目標
- **同時接続数**: 500ユーザー
- **1日あたりリクエスト数**: 100万リクエスト
- **ピーク時RPS**: 200リクエスト/秒

### パフォーマンス監視

#### SLI（Service Level Indicator）
- **可用性**: 99.9%
- **レスポンス時間**: P95 < 1秒
- **エラー率**: < 0.1%

#### SLO（Service Level Objective）
- **月間稼働率**: 99.9%以上
- **API応答時間**: 95%のリクエストが1秒以内
- **ページロード時間**: 95%のページが2秒以内

本インフラストラクチャ設計に基づいて構築することで、Project Forestを安全で高性能、かつ運用しやすい環境で提供することができます。